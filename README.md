# AWS Role Request System

Mattermost 기반 AWS IAM Role 임시 권한 요청/승인 시스템

## 개요

개발자가 Mattermost에서 `/request-role` 명령어로 AWS 임시 권한을 요청하고, 관리자가 승인하면 지정된 시간 동안만 유효한 IAM Role이 자동 생성되는 시스템입니다.

## 사용자 흐름도

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              사용자 흐름도                                    │
└─────────────────────────────────────────────────────────────────────────────┘

[사용자]                        [관리자]                         [시스템]
   │                              │                                │
   │ 1. /request-role 입력         │                                │
   │──────────────────────────────┼───────────────────────────────>│
   │                              │                                │
   │ 2. 다이얼로그 표시               │                                │
   │<─────────────────────────────┼────────────────────────────────│
   │   - IAM User명                │                                │
   │   - Environment              │                                │
   │   - Service                  │                                │
   │   - 권한 유형                  │                                │
   │   - 대상 AWS 서비스             │                                │
   │   - 시작/종료 시간              │                                │
   │   - 목적                     │                                │
   │                              │                                │
   │ 3. 요청 제출                  │                                │
   │──────────────────────────────┼───────────────────────────────>│
   │                              │                                │
   │ 4. "요청 제출됨" DM 수신       │                                │
   │<─────────────────────────────┼────────────────────────────────│
   │                              │                                │
   │                              │ 5. 승인 요청 메시지 수신         │
   │                              │<───────────────────────────────│
   │                              │   [승인] [반려] 버튼            │
   │                              │                                │
   │                              │ 6. [승인] 클릭                  │
   │                              │───────────────────────────────>│
   │                              │                                │
   │ 7. "승인됨" DM 수신            │                                │
   │<─────────────────────────────┼────────────────────────────────│
   │   - 시작 시간에 Role 생성 예정  │                                │
   │                              │                                │
   │                              │              [시작 시간 도달]    │
   │                              │                                │
   │ 8. "Role 생성됨" DM 수신       │                                │
   │<─────────────────────────────┼────────────────────────────────│
   │   - Role ARN                 │                                │
   │   - Switch Role 방법          │                                │
   │                              │                                │
   │ 9. AWS Console에서            │                                │
   │    Switch Role 수행           │                                │
   │──────────────────────────────┼───────────────────────────────>│
   │                              │                                │
   │ 10. 권한 사용                 │                                │
   │    (Env/Service 태그 기반)    │                                │
   │                              │                                │
   │                              │              [종료 시간 도달]    │
   │                              │                                │
   │ 11. "권한 만료" DM 수신        │                                │
   │<─────────────────────────────┼────────────────────────────────│
   │                              │                                │
   │                              │                 Role/Policy 삭제│
   │                              │                                │
```

## 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            시스템 아키텍처                                    │
└─────────────────────────────────────────────────────────────────────────────┘

                                 ┌─────────────────┐
                                 │   Mattermost    │
                                 │     Server      │
                                 └────────┬────────┘
                                          │
                    ┌─────────────────────┼─────────────────────┐
                    │                     │                     │
                    ▼                     ▼                     ▼
           /request-role          승인/반려 버튼           다이얼로그 제출
                    │                     │                     │
                    └─────────────────────┼─────────────────────┘
                                          │
                                          ▼
                              ┌───────────────────────┐
                              │    API Gateway        │
                              │  (REST API)           │
                              ├───────────────────────┤
                              │ /slash                │
                              │ /interactive          │
                              │ /dialog               │
                              └───────────┬───────────┘
                                          │
                    ┌─────────────────────┼─────────────────────┐
                    │                     │                     │
                    ▼                     ▼                     ▼
        ┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐
        │ Request Handler   │ │ Approval Handler  │ │ Role Manager      │
        │ Lambda            │ │ Lambda            │ │ Lambda            │
        ├───────────────────┤ ├───────────────────┤ ├───────────────────┤
        │ - 다이얼로그 표시  │ │ - 승인/반려 처리   │ │ - Role 생성       │
        │ - 요청 저장       │ │ - 즉시 Role 생성   │ │ - Role 삭제       │
        │ - 승인채널 전달   │ │   (시작시간 과거시) │ │ - Policy 관리     │
        └─────────┬─────────┘ └─────────┬─────────┘ └─────────┬─────────┘
                  │                     │                     │
                  └─────────────────────┼─────────────────────┘
                                        │
                    ┌───────────────────┼───────────────────┐
                    │                   │                   │
                    ▼                   ▼                   ▼
        ┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐
        │    DynamoDB       │ │  EventBridge      │ │      IAM          │
        │   (RoleRequests)  │ │   Scheduler       │ │                   │
        ├───────────────────┤ ├───────────────────┤ ├───────────────────┤
        │ - 요청 정보 저장   │ │ - 시작 시간 스케줄 │ │ - Dynamic Role    │
        │ - 상태 관리       │ │ - 종료 시간 스케줄 │ │ - Dynamic Policy  │
        └───────────────────┘ └───────────────────┘ └───────────────────┘
```

## 권한 체계

### 권한 유형 (Permission Type)

| 유형 | 설명 | 조회 | 수정 | 생성 | 삭제 |
|------|------|:----:|:----:|:----:|:----:|
| read_only | 조회만 | ✅ | ❌ | ❌ | ❌ |
| read_update | 조회 + 수정 | ✅ | ✅ | ❌ | ❌ |
| read_update_create | 조회 + 수정 + 생성 | ✅ | ✅ | ✅ | ❌ |
| full | 전체 | ✅ | ✅ | ✅ | ✅ |

### 대상 AWS 서비스

- EC2 (인스턴스, 볼륨, 스냅샷, 보안그룹 등)
- RDS (DB 인스턴스, 클러스터, 스냅샷 등)
- Lambda (함수, 별칭, 이벤트 소스 등)
- S3 (버킷, 객체 등)
- 전체 (위 4개 서비스 모두)

### 태그 기반 권한 제어

- **조회(Read)**: 태그 조건 없이 모든 리소스 조회 가능
- **수정(Update)**: `Env`와 `Service` 태그가 일치하는 리소스만 수정 가능
- **생성(Create)**: 생성 시 `Env`와 `Service` 태그 필수 지정
- **삭제(Delete)**: `Env`와 `Service` 태그가 일치하는 리소스만 삭제 가능

## Switch Role 사용 방법

### AWS Console에서 Switch Role

1. AWS Console 우측 상단 계정 이름 클릭
2. **"Switch Role"** 또는 **"역할 전환"** 클릭
3. 정보 입력:
   - **Account**: `680877507363`
   - **Role**: DM으로 받은 Role 이름 (예: `dynamic-role-he12569-prod-safety-...`)
   - **Display Name**: 원하는 이름 (예: "Safety Prod")
4. **"Switch Role"** 클릭

### AWS CLI에서 사용

```bash
# 1. assume-role 실행
aws sts assume-role \
  --role-arn arn:aws:iam::680877507363:role/dynamic-role-xxx \
  --role-session-name my-session

# 2. 반환된 자격 증명을 환경 변수로 설정
export AWS_ACCESS_KEY_ID=<AccessKeyId>
export AWS_SECRET_ACCESS_KEY=<SecretAccessKey>
export AWS_SESSION_TOKEN=<SessionToken>

# 3. AWS CLI 명령어 사용
aws ec2 describe-instances
```

## 주요 특징

- **시간 제한**: 요청한 시간 동안만 권한 유효 (최대 24시간)
- **자동 정리**: 만료 시간에 Role/Policy 자동 삭제
- **태그 기반**: Env/Service 태그로 리소스 접근 범위 제한
- **감사 추적**: DynamoDB에 모든 요청/승인 기록 저장
- **KST 기준**: 모든 시간은 한국 시간(KST) 기준

## 환경 및 서비스 목록

### Environment (Env)
- prod, test, infra, staging, dev

### Service
- aihub, safety, infra, biz_drive, alarm
- unit-mgnt, software-updater, sms-sender, ai-nams
- fleet-mgnt, bp-eval, form-system, sko-sso-auth
- sko-sftp, asset-mgmt, eb, ocean, mobile-app

## 관리자 기능

관리자(hojinchang, cation98)는 승인 채널에서 요청을 승인/반려할 수 있습니다.

## 기술 스택

- **Runtime**: Python 3.11
- **Infrastructure**: AWS SAM (Serverless Application Model)
- **Services**: Lambda, API Gateway, DynamoDB, EventBridge Scheduler, IAM
- **Chat**: Mattermost (Slash Commands, Interactive Messages, Dialogs)
